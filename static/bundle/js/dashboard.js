function createBlock(x,y){return use=document.createElementNS("http://www.w3.org/2000/svg","use"),use.setAttributeNS(null,"href","#cube"),use.setAttributeNS(null,"x",x),use.setAttributeNS(null,"y",y),use}function appendBlocks(blocks){$(".blue-cube g.move").each(function(){$(this).empty()});for(var cubes=document.querySelectorAll(".blue-cube g.move"),i=0;i<blocks.length;i++){var block=blocks[i];for(let i2=0;i2<cubes.length;i2++){var cube=cubes[i2];cube.appendChild(createBlock(block[0],block[1]))}}for(let i2=0;i2<cubes.length;i2++){var cube=cubes[i2],use2=document.createElementNS("http://www.w3.org/2000/svg","use");use2.setAttributeNS(null,"href","#cube-small"),use2.setAttributeNS(null,"x",129),use2.setAttributeNS(null,"y",56),cube.appendChild(use2)}}$(document).ready(function(){$("#bookmark-button").on("click",function(event){var tickIcon2=$("<i class='fas fa-check' style='width:15px;'></i>"),spinnerSmall=$('<div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">Loading...</span></div>'),bookmarkIcon=$("<i class='far fa-bookmark' style='width:15px;'></i>"),errorIcon=$("<i class='fas fa-exclamation' style='width:15px;'></i>");fetch("/dashboard/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(state.validators)}).then(function(res){console.log("response",res),res.status===200&&!res.redirected?(console.log("success"),$("#bookmark-button").empty().append(tickIcon2),setTimeout(function(){$("#bookmark-button").empty().append(bookmarkIcon)},1e3)):res.redirected?(console.log("redirected!"),$("#bookmark-button").attr("data-original-title","Please login or sign up first."),$("#bookmark-button").tooltip("show"),$("#bookmark-button").empty().append(errorIcon),setTimeout(function(){$("#bookmark-button").empty().append(bookmarkIcon),$("#bookmark-button").tooltip("hide"),$("#bookmark-button").attr("data-original-title","Save all to Watchlist")},2e3)):($("#bookmark-button").empty().append(errorIcon),setTimeout(function(){$("#bookmark-button").empty().append(bookmarkIcon)},2e3))}).catch(function(err){$("#bookmark-button").empty().append(errorIcon),setTimeout(function(){$("#bookmark-button").empty().append(bookmarkIcon)},2e3),console.log(err)})});var clearSearch=$("#clear-search"),copyIcon=$("<i class='fa fa-copy' style='width:15px'></i>"),tickIcon=$("<i class='fas fa-check' style='width:15px;'></i>");clearSearch.on("click",function(){clearSearch.empty().append(tickIcon),setTimeout(function(){clearSearch.empty().append(copyIcon)},500)});var validatorsDataTable=window.vdt=$("#validators").DataTable({processing:!0,serverSide:!1,ordering:!0,searching:!0,paging:!1,info:!1,preDrawCallback:function(){try{$("#validators").find('[data-toggle="tooltip"]').tooltip("dispose")}catch(e){}},drawCallback:function(settings){$("#validators").find('[data-toggle="tooltip"]').tooltip()},order:[[1,"asc"]],columnDefs:[{targets:0,data:"0",render:function(data,type,row,meta){return type=="sort"||type=="type"?data:'<a href="/validator/'+data+'">0x'+data.substr(0,8)+"...</a>"}},{targets:1,data:"1",render:function(data,type,row,meta){return type=="sort"||type=="type"?data:'<a href="/validator/'+data+'">'+data+"</a>"}},{targets:2,data:"2",render:function(data,type,row,meta){return type=="sort"||type=="type"?data?data[0]:null:`${data[0]} (${data[1]})`}},{targets:3,data:"3",render:function(data,type,row,meta){if(type=="sort"||type=="type")return data?data[0]:-1;var d=data.split("_"),s=d[0].charAt(0).toUpperCase()+d[0].slice(1);return d[1]==="offline"?`<span style="display:none">${d[1]}</span><span data-toggle="tooltip" data-placement="top" title="No attestation in the last 2 epochs">${s} <i class="fas fa-power-off fa-sm text-danger"></i></span>`:d[1]==="online"?`<span style="display:none">${d[1]}</span><span>${s} <i class="fas fa-power-off fa-sm text-success"></i></span>`:`<span>${s}</span>`}},{targets:4,data:"4",render:function(data,type,row,meta){return type=="sort"||type=="type"?data?data[0]:null:data===null?"-":`<span data-toggle="tooltip" data-placement="top" title="${luxon.DateTime.fromMillis(data[1]*1e3).toRelative({style:"short"})}">${luxon.DateTime.fromMillis(data[1]*1e3).toRelative({style:"short"})} (<a href="/epoch/${data[0]}">Epoch ${data[0]}</a>)</span>`}},{targets:5,data:"5",render:function(data,type,row,meta){return type=="sort"||type=="type"?data?data[0]:null:data===null?"-":`<span data-toggle="tooltip" data-placement="top" title="${luxon.DateTime.fromMillis(data[1]*1e3).toRelative({style:"short"})}">${luxon.DateTime.fromMillis(data[1]*1e3).toRelative({style:"short"})} (<a href="/epoch/${data[0]}">Epoch ${data[0]}</a>)</span>`}},{targets:6,data:"6",render:function(data,type,row,meta){return type=="sort"||type=="type"?data?data[0]:null:data===null?"-":`<span data-toggle="tooltip" data-placement="top" title="${luxon.DateTime.fromMillis(data[1]*1e3).toRelative({style:"short"})}">${luxon.DateTime.fromMillis(data[1]*1e3).toRelative({style:"short"})} (<a href="/epoch/${data[0]}">Epoch ${data[0]}</a>)</span>`}},{targets:7,data:"7",render:function(data,type,row,meta){return type=="sort"||type=="type"?data?data[0]:null:data===null?"No Attestation found":`<span data-toggle="tooltip" data-placement="top" title="${luxon.DateTime.fromMillis(data[1]*1e3).toRelative({style:"short"})}">${luxon.DateTime.fromMillis(data[1]*1e3).toRelative({style:"short"})} (<a href="/block/${data[0]}">Block ${data[0]}</a>)</span>`}},{targets:8,data:"8",render:function(data,type,row,meta){return type=="sort"||type=="type"?data?data[0]+data[1]:null:`<span data-toggle="tooltip" data-placement="top" title="${data[0]} executed / ${data[1]} missed"><span class="text-success">${data[0]}</span> / <span class="text-danger">${data[1]}</span></span>`}}]}),bhValidators=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,identify:function(obj){return obj.index},remote:{url:"/search/indexed_validators/%QUERY",wildcard:"%QUERY"}}),bhEth1Addresses=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,identify:function(obj){return obj.eth1_address},remote:{url:"/search/indexed_validators_by_eth1_addresses/%QUERY",wildcard:"%QUERY"}}),bhName=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,identify:function(obj){return obj.name},remote:{url:"/search/indexed_validators_by_name/%QUERY",wildcard:"%QUERY"}}),bhGraffiti=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,identify:function(obj){return obj.graffiti},remote:{url:"/search/indexed_validators_by_graffiti/%QUERY",wildcard:"%QUERY"}});$(".typeahead-dashboard").typeahead({minLength:1,highlight:!0,hint:!1,autoselect:!1},{limit:5,name:"validators",source:bhValidators,display:"index",templates:{header:"<h3>Validators</h3>",suggestion:function(data){return`<div class="text-monospace text-truncate">${data.index}: ${data.pubkey}</div>`}}},{limit:5,name:"addresses",source:bhEth1Addresses,display:"address",templates:{header:"<h3>Validators by ETH1 Addresses</h3>",suggestion:function(data){var len=data.validator_indices.length>100?"100+":data.validator_indices.length;return`<div class="text-monospace" style="display:flex"><div class="text-truncate" style="flex:1 1 auto;">${data.eth1_address}</div><div style="max-width:fit-content;white-space:nowrap;">${len}</div></div>`}}},{limit:5,name:"graffiti",source:bhGraffiti,display:"graffiti",templates:{header:"<h3>Validators by Graffiti</h3>",suggestion:function(data){var len=data.validator_indices.length>100?"100+":data.validator_indices.length;return`<div class="text-monospace" style="display:flex"><div class="text-truncate" style="flex:1 1 auto;">${data.graffiti}</div><div style="max-width:fit-content;white-space:nowrap;">${len}</div></div>`}}},{limit:5,name:"name",source:bhName,display:"name",templates:{header:"<h3>Validators by Name</h3>",suggestion:function(data){var len=data.validator_indices.length>100?"100+":data.validator_indices.length;return`<div class="text-monospace" style="display:flex"><div class="text-truncate" style="flex:1 1 auto;">${data.name}</div><div style="max-width:fit-content;white-space:nowrap;">${len}</div></div>`}}}),$(".typeahead-dashboard").on("focus",function(event){event.target.value!==""&&$(this).trigger($.Event("keydown",{keyCode:40}))}),$(".typeahead-dashboard").on("input",function(){$(".tt-suggestion").first().addClass("tt-cursor")}),$(".typeahead-dashboard").on("typeahead:select",function(ev,sug){sug.validator_indices?addValidators(sug.validator_indices):addValidator(sug.index),$(".typeahead-dashboard").typeahead("val","")}),$("#pending").on("click","button",function(){var data=pendingTable.row($(this).parents("tr")).data();removeValidator(data[1])}),$("#active").on("click","button",function(){var data=activeTable.row($(this).parents("tr")).data();removeValidator(data[1])}),$("#ejected").on("click","button",function(){var data=ejectedTable.row($(this).parents("tr")).data();removeValidator(data[1])}),$("#selected-validators").on("click",".remove-validator",function(){removeValidator(this.parentElement.dataset.validatorIndex)}),$(".multiselect-border input").on("focus",function(event){$(".multiselect-border").addClass("focused")}),$(".multiselect-border input").on("blur",function(event){$(".multiselect-border").removeClass("focused")}),$("#clear-search").on("click",function(event){state&&(state=setInitialState(),localStorage.removeItem("dashboard_validators"),window.location="/dashboard")});function setInitialState(){var _state={};return _state.validators=[],_state.validatorsCount={pending:0,active:0,ejected:0,offline:0},_state}var state=setInitialState();setValidatorsFromURL(),renderSelectedValidators(),updateState();function renderSelectedValidators(){var elHolder=document.getElementById("selected-validators");$("#selected-validators .item").remove();for(var elsItems=[],i=0;i<state.validators.length;i++){var v=state.validators[i],elItem=document.createElement("li");elItem.classList="item",elItem.dataset.validatorIndex=v,elItem.innerHTML=v+' <i class="fas fa-times-circle remove-validator"></i>',elsItems.push(elItem)}elHolder.prepend(...elsItems)}function renderDashboardInfo(){var el=document.getElementById("dashboard-info");el.innerText=`Found ${state.validatorsCount.pending} pending, ${state.validatorsCount.active_online+state.validatorsCount.active_offline} active and ${state.validatorsCount.exited} exited validators`}function setValidatorsFromURL(){var usp=new URLSearchParams(window.location.search),validatorsStr=usp.get("validators");if(!validatorsStr){var validatorsStr=localStorage.getItem("dashboard_validators");validatorsStr?(state.validators=JSON.parse(validatorsStr),state.validators=state.validators.filter((v,i)=>(v=escape(v),isNaN(parseInt(v))?!1:state.validators.indexOf(v)===i)),state.validators.sort(sortValidators)):state.validators=[];return}state.validators=validatorsStr.split(","),state.validators=state.validators.filter((v,i)=>(v=escape(v),isNaN(parseInt(v))?!1:state.validators.indexOf(v)===i)),state.validators.sort(sortValidators),state.validators.length>100&&(state.validators=state.validators.slice(0,100),console.log("100 validators limit reached"),alert("You can not add more than 100 validators to your dashboard"))}function addValidators(indices){var limitReached=!1;indicesLoop:for(var j=0;j<indices.length;j++){if(state.validators.length>=100){limitReached=!0;break indicesLoop}for(var index=indices[j]+"",i=0;i<state.validators.length;i++)if(state.validators[i]===index)continue indicesLoop;state.validators.push(index)}state.validators.sort(sortValidators),renderSelectedValidators(),updateState(),limitReached&&(console.log("100 validators limit reached"),alert("You can not add more than 100 validators to your dashboard"))}function addValidator(index){if(state.validators.length>100){alert("Too much validators, you can not add more than 100 validators to your dashboard!");return}index=index+"";for(var i=0;i<state.validators.length;i++)if(state.validators[i]===index)return;state.validators.push(index),state.validators.sort(sortValidators),renderSelectedValidators(),updateState()}function removeValidator(index){for(var i=0;i<state.validators.length;i++)if(state.validators[i]===index){if(state.validators.splice(i,1),state.validators.sort(sortValidators),state.validators.length===0){state=setInitialState(),localStorage.removeItem("dashboard_validators"),window.location="/dashboard";return}else renderSelectedValidators(),updateState();return}}function sortValidators(a,b){var ai=parseInt(a),bi=parseInt(b);return ai-bi}function addChange(selector,value){if(selector!==void 0||selector!==null){var element=document.querySelector(selector);element!==void 0?(element.classList.remove("decreased"),element.classList.remove("increased"),value<0&&element.classList.add("decreased"),value>0&&element.classList.add("increased")):console.error("Could not find element with selector",selector)}else console.error("selector is not defined",selector)}function updateState(){if(localStorage.setItem("dashboard_validators",JSON.stringify(state.validators)),state.validators.length){console.log("length",state.validators);var qryStr="?validators="+state.validators.join(","),newUrl=window.location.pathname+qryStr;window.history.replaceState(null,"Dashboard",newUrl)}var t0=Date.now();state.validators&&state.validators.length?(document.querySelector("#bookmark-button").style.visibility="visible",document.querySelector("#copy-button").style.visibility="visible",document.querySelector("#clear-search").style.visibility="visible",$.ajax({url:"/dashboard/data/earnings"+qryStr,success:function(result){var t1=Date.now();if(console.log(`loaded earnings: fetch: ${t1-t0}ms`),!result)return;var lastDay=(result.lastDay/1e9*exchangeRate).toFixed(4),lastWeek=(result.lastWeek/1e9*exchangeRate).toFixed(4),lastMonth=(result.lastMonth/1e9*exchangeRate).toFixed(4),total=(result.total/1e9*exchangeRate).toFixed(4);console.log(total,exchangeRate,result.total),addChange("#earnings-day-header",lastDay),addChange("#earnings-week-header",lastWeek),addChange("#earnings-month-header",lastMonth),addChange("#earnings-total-header",total),document.querySelector("#earnings-day").innerHTML=(lastDay||"0.000")+" <span class='small text-muted'>"+currency+"</span>",document.querySelector("#earnings-week").innerHTML=(lastWeek||"0.000")+" <span class='small text-muted'>"+currency+"</span>",document.querySelector("#earnings-month").innerHTML=(lastMonth||"0.000")+" <span class='small text-muted'>"+currency+"</span>",document.querySelector("#earnings-total").innerHTML=(total||"0.000")+" <span class='small text-muted'>"+currency+"</span>"}}),$.ajax({url:"/dashboard/data/validators"+qryStr,success:function(result){var t1=Date.now();if(console.log(`loaded validators-data: length: ${result.data.length}, fetch: ${t1-t0}ms`),!result||!result.data.length){document.getElementById("validators-table-holder").style.display="none";return}state.validatorsCount.pending=0,state.validatorsCount.active_online=0,state.validatorsCount.active_offline=0,state.validatorsCount.slashing_online=0,state.validatorsCount.slashing_offline=0,state.validatorsCount.exiting_online=0,state.validatorsCount.exiting_offline=0,state.validatorsCount.exited=0,state.validatorsCount.slashed=0;for(var i=0;i<result.data.length;i++){var v=result.data[i],vIndex=v[1],vState=v[3];state.validatorsCount[vState]||(state.validatorsCount[vState]=0),state.validatorsCount[vState]++;var el=document.querySelector(`#selected-validators .item[data-validator-index="${vIndex}"]`);el&&(el.dataset.state=vState)}validatorsDataTable.clear(),validatorsDataTable.rows.add(result.data).draw(),validatorsDataTable.column(6).visible(!1),requestAnimationFrame(()=>{validatorsDataTable.columns.adjust().responsive.recalc()}),document.getElementById("validators-table-holder").style.display="block",renderDashboardInfo()}})):(document.querySelector("#copy-button").style.visibility="hidden",document.querySelector("#bookmark-button").style.visibility="hidden",document.querySelector("#clear-search").style.visibility="hidden"),$("#copy-button").attr("data-clipboard-text",window.location.href),renderCharts()}window.onpopstate=function(event){setValidatorsFromURL(),renderSelectedValidators(),updateState()},window.addEventListener("storage",function(e){var validatorsStr=localStorage.getItem("dashboard_validators");if(JSON.stringify(state.validators)===validatorsStr)return;validatorsStr?state.validators=JSON.parse(validatorsStr):state.validators=[],state.validators=state.validators.filter((v,i)=>state.validators.indexOf(v)===i),state.validators.sort(sortValidators),renderSelectedValidators(),updateState()});function renderCharts(){var t0=Date.now();if(document.getElementById("chart-holder").style.display="flex",state.validators&&state.validators.length){var qryStr="?validators="+state.validators.join(",");$.ajax({url:"/dashboard/data/balance"+qryStr,success:function(result){for(var t1=Date.now(),balance=new Array(result.length),effectiveBalance=new Array(result.length),validatorCount=new Array(result.length),utilization=new Array(result.length),i=0;i<result.length;i++){var res=result[i];validatorCount[i]=[res[0],res[1]],balance[i]=[res[0],res[2]],effectiveBalance[i]=[res[0],res[3]],utilization[i]=[res[0],res[3]/(res[1]*(32*exchangeRate))]}var t2=Date.now();createBalanceChart(effectiveBalance,balance,utilization);var t3=Date.now();console.log(`loaded balance-data: length: ${result.length}, fetch: ${t1-t0}ms, aggregate: ${t2-t1}ms, render: ${t3-t2}ms`)}}),$.ajax({url:"/dashboard/data/proposals"+qryStr,success:function(result){var t1=Date.now(),t2=Date.now();result&&result.length&&createProposedChart(result);var t3=Date.now();console.log(`loaded proposal-data: length: ${result.length}, fetch: ${t1-t0}ms, render: ${t3-t2}ms`)}})}}});function createBalanceChart(effective,balance,utilization,missedAttestations){Highcharts.stockChart("balance-chart",{exporting:{scale:1},rangeSelector:{enabled:!1},chart:{type:"line"},legend:{enabled:!0},title:{text:"Balance History for all Validators"},xAxis:{type:"datetime",range:7*24*60*60*1e3,labels:{formatter:function(){var epoch=timeToEpoch(this.value),orig=this.axis.defaultLabelFormatter.call(this);return`${orig}<br/>Epoch ${epoch}`}}},tooltip:{formatter:function(tooltip){var orig=tooltip.defaultFormatter.call(this,tooltip),epoch=timeToEpoch(this.x);return orig[0]=`${orig[0]}<span style="font-size:10px">Epoch ${epoch}</span>`,orig}},yAxis:[{title:{text:"Balance ["+currency+"]"},opposite:!1,labels:{formatter:function(){return this.value.toFixed(0)}}},{title:{text:"Validator Effectiveness"},labels:{formatter:function(){return(this.value*100).toFixed(2)+"%"}},opposite:!0}],series:[{name:"Balance",yAxis:0,data:balance},{name:"Effective Balance",yAxis:0,step:!0,data:effective},{name:"Validator Effectiveness",yAxis:1,data:utilization,tooltip:{pointFormatter:function(){return`<span style="color:${this.color}">\u25CF</span> ${this.series.name}: <b>${(this.y*100).toFixed(2)}%</b><br/>`}}}]})}function createProposedChart(data){var proposed=[],missed=[],orphaned=[];data.map(d=>{d[1]==1?proposed.push([d[0]*1e3,1]):d[1]==2?missed.push([d[0]*1e3,1]):d[1]==3&&orphaned.push([d[0]*1e3,1])}),Highcharts.stockChart("proposed-chart",{chart:{type:"column"},title:{text:"Proposal History for all Validators"},legend:{enabled:!0},colors:["#7cb5ec","#ff835c","#e4a354","#2b908f","#f45b5b","#91e8e1"],xAxis:{lineWidth:0,tickColor:"#e5e1e1"},yAxis:[{title:{text:"# of Possible Proposals"},opposite:!1}],plotOptions:{column:{stacking:"normal",dataGrouping:{enabled:!0,forced:!0,units:[["day",[1]]]}}},series:[{name:"Proposed",color:"#7cb5ec",data:proposed},{name:"Missed",color:"#ff835c",data:missed},{name:"Orphaned",color:"#e4a354",data:orphaned}],rangeSelector:{enabled:!1}})}
