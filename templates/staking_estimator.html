{{ define "js" }}
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="/js/highcharts-global-options.js"></script>
<script>

var poolStaking = document.getElementById('staking-variable-poolStaking').checked

function calcIssuanceRate(totalStake) {
	var rewardPerDay = calcRewardPerDay(totalStake)
	var rewardPerYear = 365 * rewardPerDay
	return rewardPerYear/32e9
}

function calcRewardPerDay(totalStake, onlinePropabilty) {
	var rewardPerEpoch = calcRewardPerEpoch(totalStake, onlinePropabilty)
	var secondsPerSlot = 12
	var slotsPerEpoch = 32
	var epochsPerDay = 3600 * 24 / (secondsPerSlot*slotsPerEpoch)
	var rewardPerDay = rewardPerEpoch * epochsPerDay
	return rewardPerDay
}

function calcRewardPerEpoch(totalStake, onlinePropabilty) {
	var valStake = 32e9
	var baseReward = valStake*64/(4*Math.sqrt(totalStake))
	var allVal = (totalStake / 32e9)|0
	var onlineVal = (allVal * onlinePropabilty)|0 
	var offlineVal = allVal - onlineVal

	var ffgRewards = 3*baseReward*onlineVal*32e9/(totalStake)
	var ffgPenalties = 3*baseReward
	var propIncentives = (baseReward/8) * (onlineVal/32)
	var attIncentives = 7/8 * baseReward * 1/1

	var totalRewards = 0
	totalRewards +=	ffgRewards * onlineVal 
	totalRewards += propIncentives * 32
	totalRewards += attIncentives * onlineVal
	totalRewards -= ffgPenalties * offlineVal
	
	return totalRewards/allVal
}

function calculate() {
	var t0 = Date.now()

	// var newPoolStaking = document.getElementById('staking-variable-poolStaking').checked
	// if (newPoolStaking != poolStaking) poolStaking = newPoolStaking

	poolStaking = document.getElementById('staking-variable-poolStaking').checked

	if (poolStaking) {
		$('.staking-variable-holder.pool').show()
		$('.staking-variable-holder.noPool').hide()
	} else {
		$('.staking-variable-holder.pool').hide()
		$('.staking-variable-holder.noPool').show()
	}

	var yourStake = parseFloat(document.getElementById('staking-variable-yourStake').value)*1e9
	var totalStake = parseFloat(document.getElementById('staking-variable-totalStake').value)*1e9
	var onlinePropability = parseFloat(document.getElementById('staking-variable-onlinePropabilty').value)/100
	var ethPrice = parseFloat(document.getElementById('staking-variable-ethPrice').value)
	var initialCosts = parseFloat(document.getElementById('staking-variable-initialCosts').value)
	var dailyCosts = parseFloat(document.getElementById('staking-variable-dailyCosts').value)
	
	if (totalStake < 32*16387*1e9*.6) {
		document.getElementById('staking-variable-totalStake').value = 32*16387*.6
		totalStake = 32*16387*1e9*.6
	}
	if (onlinePropability < .01) {
		document.getElementById('staking-variable-onlinePropabilty').value = 1
		onlinePropability = .01
	}
	if (ethPrice < 1) {
		document.getElementById('staking-variable-ethPrice').value = 1
		ethPrice = 1
	}
	if (dailyCosts < 0) {
		document.getElementById('staking-variable-dailyCosts').value = 0
		dailyCosts = 0
	}

	var rewardPerDay = calcRewardPerDay(totalStake, onlinePropability)
	var dailyCostsGwei = 1e9 * dailyCosts/ethPrice
	var incomePerDay   = ((rewardPerDay     - dailyCostsGwei    )/1e9).toFixed(4)
	var incomePerWeek  = ((rewardPerDay*7   - dailyCostsGwei*7  )/1e9).toFixed(4)
	var incomePerMonth = ((rewardPerDay*31  - dailyCostsGwei*31 )/1e9).toFixed(4)
	var incomePerYear  = ((rewardPerDay*365 - dailyCostsGwei*365)/1e9).toFixed(4)

	var incomePerDay$   = (incomePerDay  *ethPrice).toFixed(4)
	var incomePerWeek$  = (incomePerWeek *ethPrice).toFixed(4)
	var incomePerMonth$ = (incomePerMonth*ethPrice).toFixed(4)
	var incomePerYear$  = (incomePerYear *ethPrice).toFixed(4)

	document.getElementById('incomePerDay').innerText   = `${incomePerDay} ETH (${incomePerDay$} $)`
	document.getElementById('incomePerWeek').innerText  = `${incomePerWeek} ETH (${incomePerWeek$} $)`
	document.getElementById('incomePerMonth').innerText = `${incomePerMonth} ETH (${incomePerMonth$} $)`
	document.getElementById('incomePerYear').innerText  = `${incomePerYear} ETH (${incomePerYear$} $)`
	
	document.getElementById('issuancePerDay').innerText   = `${(100*incomePerDay/32  ).toFixed(2)} %`
	document.getElementById('issuancePerWeek').innerText  = `${(100*incomePerWeek/32 ).toFixed(2)} %`
	document.getElementById('issuancePerMonth').innerText = `${(100*incomePerMonth/32).toFixed(2)} %`
	document.getElementById('issuancePerYear').innerText  = `${(100*incomePerYear/32 ).toFixed(2)} %`

	var stakedSeriesData = []
	var onlineSeriesData = []
	var priceSeriesData = []
	var costsSeriesData = []
	var theoreticalBalanceSeriesData = []

	for (var i=500e3; i<=6e6; i+=500e3) {
		var rpd = calcRewardPerDay(i*1e9, onlinePropability)
		var ipd = rpd - dailyCostsGwei
		var ipy = 356 * ipd
		stakedSeriesData.push([i, parseFloat((100*ipy/32e9).toFixed(2))])
	}

	for (var i=0.4; i<=1; i+=.02) {
		var rpd = calcRewardPerDay(totalStake, i)
		var ipd = rpd - dailyCostsGwei
		var ipy = 356 * ipd
		onlineSeriesData.push([parseFloat((i).toFixed(2)), parseFloat((100*ipy/32e9).toFixed(2))])
	}

	for (var i=20; i<=1000; i+=20) {
		var rpd = calcRewardPerDay(totalStake, onlinePropability)
		var dailyCostsGwei = 1e9 * dailyCosts/i
		var ipd = rpd - dailyCostsGwei
		var ipy = 356 * ipd
		priceSeriesData.push([i, parseFloat((100*ipy/32e9).toFixed(2))])
	}

	for (var i=0.00; i<=5; i+=0.2) {
		var rpd = calcRewardPerDay(totalStake, onlinePropability)
		var dailyCosts = i
		var dailyCostsGwei = 1e9 * dailyCosts/ethPrice
		var ipd = rpd - dailyCostsGwei
		var ipy = 356 * ipd
		costsSeriesData.push([parseFloat((i).toFixed(2)), parseFloat((100*ipy/32e9).toFixed(2))])
	}

	for (var i=0; i<10; i++) {
		theoreticalBalanceSeriesData.push([Date.now()+i*3600*1000, i*0.5])
	}

	Highcharts.chart('issuanceOverStakedChart',{
		title: {
			text: 'Yearly Validator Issuance by Total Staked Ether'
		},
		series: [{
			name: 'Validator Issuance (%)',
			data: stakedSeriesData,
		}],
		yAxis: [{ title: { text: 'Validator Issuance (%)' } }],
		xAxis: [{ title: { text: 'Staked Ether (ETH)' } }],
		legend: { enabled: false },
		navigator: { enabled: false },
	})

	Highcharts.chart('issuanceOverOnlineChart',{
		title: {
			text: 'Yearly Validator Issuance by Network Online-Propabilty'
		},
		series: [{
			name: 'Validator Issuance (%)',
			data: onlineSeriesData,
		}],
		yAxis: [{ title: { text: 'Validator Issuance (%)' } }],
		xAxis: [{ title: { text: 'Avg Network Online Propability (%)' } }],
		legend: { enabled: false },
		navigator: { enabled: false },
	})

	Highcharts.chart('issuanceOverETHPriceChart',{
		title: {
			text: 'Yearly Validator Issuance by ETH Price'
		},
		series: [{
			name: 'Validator Issuance (%)',
			data: priceSeriesData,
		}],
		yAxis: [{ title: { text: 'Validator Issuance (%)' } }],
		xAxis: [{ title: { text: 'Eth price ($)' } }],
		legend: { enabled: false },
		navigator: { enabled: false },
	})

	Highcharts.chart('issuanceOverDailyCostsChart',{
		title: {
			text: 'Yearly Validator Issuance by Daily costs'
		},
		series: [{
			name: 'Validator Issuance (%)',
			data: costsSeriesData,
		}],
		yAxis: [{ title: { text: 'Validator Issuance (%)' } }],
		xAxis: [{ title: { text: 'Costs to run a validator ($/day)' } }],
		legend: { enabled: false },
		navigator: { enabled: false },
	})


	Highcharts.stockChart('theoreticalBalanceChart',{
		title: {
			text: 'Estimated Income over Time'
		},
		series: [{
			name: 'Income ($)',
			data: theoreticalBalanceSeriesData,
		}],
		yAxis: [{ title: { text: 'Income ($)' } }],
		// xAxis: [{ title: { text: 'Eth price ($)' } }],
		legend: { enabled: false },
		navigator: { enabled: false },
	})

	console.log(`calculation done in ${Date.now()-t0}ms`)
}

calculate()

$('.staking-variable').on('change',function(){
	calculate()
})

</script>
{{ end }}

{{ define "css" }}
{{ end }}

{{ define "content" }}
<div class="mb-3">
	<div class="d-md-flex py-2 justify-content-md-between">
		<h1 class="h4 mb-1 mb-md-0"><i class="fas fa-chart-bar"></i> Staking Estimator</h1>
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb font-size-1 mb-0" style="padding:0; background-color:transparent;">
				<li class="breadcrumb-item"><a href="/" title="Home">Home</a></li>
				<li class="breadcrumb-item active" aria-current="page">Staking Estimator</li>
			</ol>
		</nav>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="row">
				<!--
				<div class="col-md-6">
					<div class="input-group">
						<div class="input-group-prepend">
							<span class="input-group-text">Total staked Ether</span>
						</div>
						<input id="staking-variable-totalStake" class="staking-variable form-control" type="number" value=500000 min=100000 step=1>
					</div>
					<div class="input-group">
						<div class="input-group-prepend">
							<span class="input-group-text">Online propability (%)</span>
						</div>
						<input id="staking-variable-totalStake" class="staking-variable form-control" type="number" value=500000 min=100000 step=1>
					</div>
					<div class="input-group">
						<div class="input-group-prepend">
							<span class="input-group-text">ETH price ($)</span>
						</div>
						<input id="staking-variable-totalStake" class="staking-variable form-control" type="number" value=500000 min=100000 step=1>
					</div>
					<div class="input-group">
						<div class="input-group-prepend">
							<span class="input-group-text">Daily costs of running a validator ($/day)</span>
						</div>
						<input id="staking-variable-totalStake" class="staking-variable form-control" type="number" value=500000 min=100000 step=1>
					</div>
				</div>
				-->
				<div class="col-md-12">
					<div style="padding:10px;">The beaconchain is a complex adaptive system. Calculations of this Staking Estimator are rough estimations.</div>
				</div>
				<div class="col-md-6">
					<div style="padding:10px;padding-bottom:0;">
						<table class="table">
							<tbody>
								<!--
								<tr>
									<th>Your staked ether (ETH, must be multiple of 32 if not staking on a pool)</th>
									<td><input id="staking-variable-yourStake" class="staking-variable" type="number" value=500000 min=100000 step=1></td>
								</tr>
								-->
								<tr>
									<th>Total staked ether of the network (ETH)</th>
									<td><input id="staking-variable-totalStake" class="staking-variable" type="number" value=500000 min=100000 step=1></td>
								</tr>
								<tr>
									<th>Online propability of the network (%)</th>
									<td><input id="staking-variable-onlinePropabilty" class="staking-variable" type="number" value=95 min=1 step=1></td>
								</tr>
								<tr>
									<th>ETH price ($)</th>
									<td><input id="staking-variable-ethPrice" class="staking-variable" type="number" value=134.05 min=0.01 step=0.01></td>
								</tr>
								<tr>
									<th>Staking in a pool</th>
									<td><input id="staking-variable-poolStaking" class="staking-variable" type="checkbox"></td>
								</tr>

								<tr class="staking-variable-holder pool">
									<th>Your staked ether (ETH)</th>
									<td><input id="staking-variable-yourStake" class="staking-variable pool" type="number" value=32 min=0.01 step=0.01></td>
								</tr>
								<tr class="staking-variable-holder pool">
									<th>Staking fee (%)</th>
									<td><input id="staking-variable-fee" class="staking-variable pool" type="number" value=0 min=0 max=100 step=1></td>
								</tr>
								<tr class="staking-variable-holder pool">
									<th>Reinvest gains</th>
									<td><input id="staking-variable-reinvest" class="staking-variable pool" type="checkbox"></td>
								</tr>

								<tr class="staking-variable-holder noPool">
									<th>Number of validators</th>
									<td><input id="staking-variable-validatorsNum" class="staking-variable noPool" type="number" value=1 min=1 step=1></td>
								</tr>
								<tr class="staking-variable-holder noPool">
									<th>Initial costs ($)</th>
									<td><input id="staking-variable-initialCosts" class="staking-variable noPool" type="number" value=0 min=0></td>
								</tr>
								<tr class="staking-variable-holder noPool">
									<th>Monthly costs for running your validators ($)</th>
									<td><input id="staking-variable-dailyCosts" class="staking-variable noPool" type="number" value=2.0 min=0></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="col-md-6">
					<div style="padding:10px;padding-bottom:0;">
						<table class="table">
							<tbody>
								<tr>
									<th>Duration</th>
									<th>Income</th>
									<th>Issuance</th>
								</tr>
								<tr>
									<th>1 day</th>
									<td id="incomePerDay"></td>
									<td id="issuancePerDay"></td>
								</tr>
								<tr>
									<th>7 days</th>
									<td id="incomePerWeek"></td>
									<td id="issuancePerWeek"></td>
								</tr>
								<tr>
									<th>31 days</th>
									<td id="incomePerMonth"></td>
									<td id="issuancePerMonth"></td>
								</tr>
								<tr>
									<th>365 days</th>
									<td id="incomePerYear"></td>
									<td id="issuancePerYear"></td>
								</tr>
							</tbody>
						</table>
						<div>
							The break-even-point is reached after <span id="breakEvenPoint">10 days</span>
						</div>
					</div>
				</div>
				<!--
				<div class="col-md-6">
					<div style="height:25%; display: flex; flex-direction:column; justify-content: center; align-items:center;">
						<h3>Estimated daily income:</h3>
						<h1 id="incomePerDay">-</h1>
					</div>
					<div style="height:25%; display: flex; flex-direction:column; justify-content: center; align-items:center;">
						<h3>Estimated weekly income:</h3>
						<h1 id="incomePerWeek">-</h1>
					</div>
					<div style="height:25%; display: flex; flex-direction:column; justify-content: center; align-items:center;">
						<h3>Estimated monthly income:</h3>
						<h1 id="incomePerMonth">-</h1>
					</div>
					<div style="height:25%; display: flex; flex-direction:column; justify-content: center; align-items:center;">
						<h3>Income Rate (% per year):</h3>
						<h1 id="issuanceRate">-</h1>
					</div>
				</div>
				-->
				<div class="col-md-12">
					<div id="theoreticalBalanceChart"></div>
				</div>
				<div class="col-md-6">
					<div id="issuanceOverStakedChart"></div>
				</div>
				<div class="col-md-6">
					<div id="issuanceOverOnlineChart"></div>
				</div>
				<div class="col-md-6">
					<div id="issuanceOverETHPriceChart"></div>
				</div>
				<div class="col-md-6">
					<div id="issuanceOverDailyCostsChart"></div>
				</div>
			</div>
		</div>
	</div>
</div>
{{ end }}
