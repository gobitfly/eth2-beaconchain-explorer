{{ define "genesis" }}
{{ if not .Genesis }}
<div class="row pt-3">
  <div class="col-lg-5 my-2">{{ template "depositProgress" .}}</div>
  <div class="col-lg-2 my-2"></div>
  <div class="col-lg-5 my-2">{{ template "genesisCountdown" .}}</div>
</div>
{{ end }}
  <div style="position:relative" class="card mt-3 index-stats">
    <div class="card-header pt-3">
      <div class="row">
        {{ template "networkStats" }}
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-lg-12">
          <h1>checklist</h1>
          <span>checklist start</span>
          <div id="checklist">
          </div>
          <span>checlist end</span>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-6 mt-3 pr-lg-2">
      {{template "recentEpochs"}}
    </div>
    <div class="col-lg-6 mt-3 pl-lg-2">
      {{ template "recentBlocks"}}
    </div>
  </div>
  <script>
    var exampleSlots = [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          },  {
            delay: 6,
            status: 'orphaned',
          }, 
          {
            delay: 8,
            status: 'proposed',
          },
          {
            delay: 6,
            status: 'scheduled',
            active: true
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
        ]
    var exampleSlots2 = [
          {
            delay: 2,
            status: 'scheduled',
          }, {
            delay: 1,
            status: 'scheduled',
          },  {
            delay: 6,
            status: 'scheduled',
          }, 
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
          {
            delay: 6,
            status: 'scheduled',
          },
        ]
    var data =  [{
        epoch: 0,
        finalized: false,
        justified: false,
        participation: 80,
        slots: exampleSlots
      }
      ,{
        epoch: 1,
        finalized: false,
        justified: false,
        participation: 67,
        slots: exampleSlots2
      },
      {
        epoch: 2,
        finalized: false,
        justified: false,
        participation: 40,
        slots: exampleSlots2
      },
      {
        epoch: 3,
        finalized: false,
        justified: false,
        participation: 0,
        slots: exampleSlots2
      },
      {
        epoch: 4,
        finalized: false,
        justified: false,
        participation: 0,
        slots: exampleSlots2
      },
      // {
			// 	epoch: 5,
			// 	participation: 60,
      // }
    ]
    var data2 =  [{
			epoch: 0,
        participation: 68,
        finalized: false,
        justified: false,
        arr: [1, 3, 65],
        slots: exampleSlots
      }
      ,{
				epoch: 1,
        participation: 70,
        finalized: false,
        justified: false,
        slots: [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          }
        ]
      },
      {
				epoch: 2,
        participation: 65,
        finalized: false,
        justified: false,
        arr: [1, 3, 65],
        slots: [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          }
        ]
      },
      {
				epoch: 3,
        participation: 46,
        finalized: false,
        justified: false,
        arr: [1, 3],
        slots: [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          }
        ]
      },
      // {
			// 	epoch: 4,
			// 	participation: 67,
      // },
      // {
			// 	epoch: 5,
			// 	participation: 60,
      // }
    ]
    var data3 =  [{
			epoch: 0,
        participation: 68,
        finalized: false,
        justified: false,
        slots: [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          }
        ]
      }
      ,{
				epoch: 1,
        participation: 70,
                finalized: false,
        justified: false,
        slots: [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          }
        ]
      },
      {
				epoch: 2,
        participation: 80,
        finalized: false,
        justified: false,
        slots: [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          }
        ]
      },
      {
				epoch: 3,
        participation: 68,
                finalized: false,
        justified: false,
        slots: [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          }
        ]
      },
      {
				epoch: 4,
        participation: 50,
                finalized: false,
        justified: false,
        slots: [
          {
            delay: 2,
            status: 'missed',
          }, {
            delay: 1,
            status: 'proposed',
          }
        ]
      },
      // {
			// 	epoch: 5,
			// 	participation: 60,
      // }
    ]
    
document.addEventListener('DOMContentLoaded', function() {

/// Chat Dimensions
var margin = {top: 20, right: 30, bottom: 0, left: 200}
var width = document.getElementById('checklist').clientWidth - 60
var height = 200 + margin.top + margin.bottom + data.length * 103



var reveal = path => path.transition()
  .duration(2000)
  .ease(d3.easeLinear)
  .attrTween("width", function() {
    var width = this.width.baseVal.value
    return d3.interpolate(0, width);
 })

roma = [
    "#ff3333",
    "#cc3333",
    "#993333",
    "#993333",
    "#993333",
    "#33cc33",
  ]

 // define a color interpolation that turnes green over 66%
var color = d3.scaleSequential()
    .domain([0, d3.max(data, d => d.participation)])
    .interpolator(d3.interpolateDiscrete(roma))

var colorProposed = d3.scaleSequential()
                    .domain([0, 12])
                    .interpolator(d3.interpolateRgb("rgba(100, 200, 100, 1)", "rgba(100, 200, 100, 0.3)"))

// Chart Svg
var svg = d3.select("#checklist").append("svg")
.attr("viewBox", [0, 0, width, height])
.attr("style", `max-width: ${width - margin.right}px; font: 10px sans-serif;`)

// Define X axis
var x = d3.scaleLinear()
    .domain([0, 100])
    .range([margin.left, width - margin.right])
    .interpolate(d3.interpolateRound)

// define Y axis
var y = d3.scaleBand()
    .domain(data.map(d => d.epoch))
    .range([margin.top, height - margin.bottom])
    .padding(0.5)
    // .round(true)

var gx = svg.append("g")
           .attr("transform", `translate(0,${margin.top})`)
           .call(d3.axisTop(x))
          //  .text("participation")
          //  .attr('x', margin.left + (width - margin.left - margin.right) / 2)
          //  .attr('y', 50) // Relative to the x axis.
           .call(g => g.select(".domain").remove())

var gy = svg.append("g")
          .attr("transform", `translate(20, 0)`)
          .call(d3.axisLeft(y))
          .call(g => g.selectAll('line').remove())
          .call(g => g.select(".domain").remove())
          // .call(g => g.selectAll("text").remove())
          
var yAxis = (g, x) => g
          .attr("transform", `translate(20, 0)`)
          .call(d3.axisLeft(x))
          .call(g => g.selectAll('line').remove())
          .call(g => g.select(".domain").remove())
          // .call(g => g.select("text").remove())

// var bar = svg.append("g")
//           .attr("text-anchor", "end")

  //   <g text-anchor="end" transform="translate(-6,${y.bandwidth() / 2})">
  //    ${data.map(d => svg`<text fill="${d3.lab(color(d.participation)).l < 60 ? "white" : "black"}" y="${y(d.epoch)}" x="${x(d.participation)}" dy="0.35em">${d.participation}</text>`)}
  //  </g>

          
  
var bars = svg.append("g")
    .selectAll("rect")
    .data(data, d => d)
    .join(
      enter => enter.append("rect"),
      update => update,
      exit => exit.remove()
    )
    // .call(reveal)
    .attr("id", ({ epoch, participation }) => epoch)
    .attr("fill", ({participation}) => color(participation))
    .attr("y", ({epoch}) => y(epoch))
    .attr("x", x(0))
    .attr("width", ({participation}) => x(participation) - x(0))
    .attr("height", y.bandwidth())

var barLabels = svg.append('g')
    .attr('text-anchor', "end")
    .attr("transform", `translate(-6, ${y.bandwidth() / 2})`)
    .selectAll('text')
    .data(data, d => d)
    .join('text')
    .attr('fill', d => `${d3.lab(color(d.participation)).l < 60 ? "white" : "black"}`)
    .attr('y', d => y(d.epoch))
    .attr('x', d => x(d.participation))
    .attr('dy', '0.35em')
    .text((d) => d.participation + '%')
   

var heatmaps = svg.append("g").attr("text-anchor", "middle")
    .selectAll("g")
    .data(data)
    .join('g')
    .attr("transform", ({ epoch }) => `translate(40, ${y(epoch)})`)

var finalizedStatus = svg.append("g")
    .selectAll("text")
    .data(data)
    .join('text')
    .attr("x", "88")
    .attr("y", ({epoch}) => y(epoch) - 5)
    .text(({finalized, justified}) => {
      if (finalized) {
        return "Finalized"
      } else if (justified) {
        return "Justified"
      } else {
        return ""
      }
    })

heatmaps.append('rect')
  .attr('width', "144")
  .attr('height', "60")
  .attr("rx", "1")
  .attr("ry", "1")
  .attr("fill", "green")
 
var slots = heatmaps.selectAll('g rect')
      .data(d => d.slots)
      .join('rect')

slots
  .attr('x', (d, i) => (((i % 8) * 18)))
  .attr('y', (d, i) => {
    return (((i - (i % 8)) / 8) * 18)
  })
  .attr("title", (s, i) => {
    if(s.active) {
      return `current slot`
    }
    if (s.status === "proposed") {
      return `slot: ${i} proposed in ${s.delay}s`
    }
    if(s.status !== "scheduled") {
      return `slot: ${i} status: ${s.status}`
    } else {
      return `slot: ${i}`
    }
    })
  .attr("data-toggle", (s, i) => s.status !== "scheduled" || s.active  ? "tooltip" : "")
  .attr('stroke-width', '1')
  .attr('stroke', (d) => d.active ? 'var(--font-color)' : 'transparent')
  // .attr("stroke", "black")
  // .attr("stroke-width", ".5")
  .attr('width', "15")
  .attr('height', "15")
  .attr("rx", "1")
  .attr("ry", "1")
  .attr("fill", (d) => {
    if(d.status === "missed") {
      return "rgba(200,100,100,0.8)"
    } else if (d.status === "proposed") {
      return colorProposed(d.delay)
    } else if (d.status === "orphaned") {
      return "rgba(100,100, 200, 0.8)"
    } else {
      return "rgba(100,100,100, 0.5)"
    }
  })


    var chart = Object.assign(svg.node(), {
      update(newData) {
        var t = svg.transition().duration(550)
        
        height = 200 + margin.top + margin.bottom + newData.length * 103
        svg = svg.attr('viewBox', `0 0 ${width} ${height}`)
        y = y.domain(newData.map(d => d.epoch)).range([margin.top, height - margin.bottom])
        gy.transition(t)
            .call(yAxis, y)
        
        bars = bars.data(newData, d => d)
            .join(
              enter => enter.append("rect"),
              update => update,
              exit => exit.remove()
            )
            // .call(reveal)
            .attr("id", ({ epoch, participation }) => epoch)
            .attr("fill", ({participation}) => color(participation))
            .attr("y", ({epoch}) => y(epoch))
            .attr("x", x(0))
            .attr("width", ({participation}) => x(participation) - x(0))
            .attr("height", y.bandwidth())

        // heatmap = heatmap.data(newData, d => d)
        //     .join(
        //       enter => enter.append("circle"),
        //       update => update,
        //       exit => exit.remove()
        //     )
        //     .attr("id", ({ epoch, participation }) => epoch)
        //     .attr("fill", "white")
        //     .attr("stroke", "black")
        //     .attr("strock-width", "3")
        //     .attr("cy", ({epoch}) => y(epoch) + margin.top - 5)
        //     .attr("cx", x(0) - margin.left + 10)
        //     .attr("r", "10")
        //     .attr("width", ({participation}) => x(participation) - x(0))
        //     .attr("height", y.bandwidth())
      }
    })
    // setTimeout(function() {
    //   chart.update(data2)
    // }, 2000)
    // setTimeout(function() {
    //   chart.update(data3)
    // }, 4000)



  })

  
  </script>
{{end}}